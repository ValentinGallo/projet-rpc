/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "projet.h"


void
projet_1(char *host)
{
	CLIENT *clnt;
	int  *resultat;
	void *vide;
	tab_outils *outils;
	tab_postes *postes;
	tab_paiements *paiements;
	personne adherent;
	informations *infos;

#ifndef	DEBUG
	clnt = clnt_create (host, PROJET, GEOM_VERSION_1, "udp");
	if (clnt == NULL) {
		clnt_pcreateerror (host);
		exit (1);
	}
#endif	/* DEBUG */

	printf("CLIENT : \n");
	resultat = init_1(vide,clnt);

	//INIT
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("Initialisation réussie\n\n");

	//Scénario 1 :
	printf("|| Scénario 1 ||\n\n");

	//Enregistrer adhérent (Etape 1)
	strcpy(adherent.prenom,"Jean");
	strcpy(adherent.nom,"Dupont");
	adherent.adherent = 1;
	resultat = enregistrer_adherent_1(&adherent, clnt); //Retourne l'id de l'adhérent
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("- [ETAPE 1] Enregistrement réussie (id de l'adhérent : %d) \n",*resultat);

	//Liste outils (Etape 2)
	int seulement_outil_dispo = 1;
	outils = lister_outils_1(&seulement_outil_dispo, clnt);
	if (outils == (tab_outils *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	printf("- [ETAPE 2]//////// Liste outils(%d dispo)  ]////////\n",outils->nbOutils);
	for(int i = 0;i<outils->nbOutils;i++){
		printf("> Outil n°%d : %s(id : %d)\n",i+1,outils->listeOutils[i].nom,outils->listeOutils[i].id);
	}
	printf("////////////////////////////////////////////////////\n");

	//Louer un outil (Etape 3)
	param_outil info_location;
	info_location.id_adherent = adherent.id;
	info_location.id_outil = 0; //Marteau
	resultat = louer_outil_1(&info_location, clnt); //Retourne id de la location
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	if(*resultat == -1) printf("Location impossible vous n'êtes pas adhérent\n");
	else printf("- [ETAPE 3] Location réussie de '%s' (id de la location : %d)\n",outils->listeOutils[info_location.id_outil].nom,*resultat);

	//Liste paiements (Etape 4)
	paiements = afficher_mode_paiement_1(&vide, clnt);
	if (paiements == (void *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	printf("- [ETAPE 4]///////// Liste Paiements(%d dispo)  ///////// \n",paiements->nbPaiements);
	for(int i = 0;i<paiements->nbPaiements;i++){
		printf("> Paiement n°%d : %s(id : %d)\n",i+1,paiements->listePaiements[i].nom,paiements->listePaiements[i].id);
	}
	printf("////////////////////////////////////////////////////////\n");

	//Effectuer paiement (Etape 5)
	param_paiement info_paiement;
	info_paiement.id_location = 1; //Location d'un marteau
	info_paiement.id_paiement = 0; //Paypal
	resultat = effectuer_paiement_1(&info_paiement, clnt);
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("- [ETAPE 5] Paiement réussie avec %s\n",paiements->listePaiements[info_paiement.id_paiement].nom);

	//Retour Outil (Etape 6)
	int id_outil = 0;
	resultat = retour_location_1(&id_outil, clnt);
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("- [ETAPE 6] Retour de l'outil %s réussie\n",outils->listeOutils[id_outil].nom);

	//Signalement d'une anomalie (Etape 7)
	id_outil = 0;
	resultat = signaler_anomalie_1(&id_outil, clnt);
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("- [ETAPE 7] Une anomalie à bien été signalé sur l'outil %s\n",outils->listeOutils[id_outil].nom); 

	//Scénario 2 :
	printf("\n|| Scénario 2 ||\n\n");

	//Afficher tarifs postes (Etape 1)
	infos = tarifs_horaires_1(&vide,clnt);
	if (infos == (informations *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("- [ETAPE 1] Tarifs : %s\n",infos->tarifs);

	//Lister postes de travail dispo (Etape 2)
	date debut;
	debut.heure = 0; //Date debut 03/01/2020 00:00
	debut.jour = 3;
	date fin;
	fin.heure = 2; //Date fin 03/01/2020 00:00
	fin.jour = 4;
	param_date dates;
	dates.date_debut = debut;
	dates.date_fin = fin;

	postes = lister_postes_1(&dates, clnt);
	if (postes == (tab_postes *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	printf("- [ETAPE 2] ]///////// Liste Postes(%d dispo)  //////////\n",postes->nbPostes);
	for(int i = 0;i<postes->nbPostes;i++){
		printf("> %s : %s (id : %d)\n",postes->listePostes[i].nom,postes->listePostes[i].description,postes->listePostes[i].id);
	}
	printf("////////////////////////////////////////////////////////\n");

	//Afficher horraires postes (Etape 3)
	infos = tarifs_horaires_1(&vide,clnt);
	if (infos == (informations *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("- [ETAPE 3] Horaires : %s \n",infos->horaires);

	//Réserver poste (Impossible car pas adhérent)  (Etape 4)
	param_poste info_poste;
	info_poste.id_adherent = 0; //Philippe Hamon (Non adhérent)
	info_poste.id_poste = 0;
	info_poste.date_debut = debut;
	info_poste.date_fin = fin;
	resultat = reserver_poste_1(&info_poste,clnt);
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	if(*resultat == -1) printf("- [ETAPE 4] Reservation impossible vous n'êtes pas adhérent \n");

	//Renouveler adhérent  (Etape 5)
	int id_adherent = 0;
	resultat = renouveler_adhesion_1(&id_adherent,clnt);
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	else printf("- [ETAPE 5] Vous êtes maintenant adhérent et avez la possibilité de louer un outil ou réserver un poste\n");

	//Réserver poste (Impossible car pas adhérent)  (Etape 6)
	resultat = reserver_poste_1(&info_poste,clnt);
	if (resultat == (int *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	if(*resultat == -1) printf("Réservation impossible vous n'êtes pas adhérent\n");
	else printf("- [ETAPE 6] Reservation reussie de '%s' (id de la reservation : %d)\n",postes->listePostes[info_poste.id_poste].nom,*resultat);
	
	
	

#ifndef	DEBUG
	clnt_destroy (clnt);
#endif	 /* DEBUG */
}


int
main (int argc, char *argv[])
{
	char *host;

	if (argc < 2) {
		printf ("usage: %s server_host\n", argv[0]);
		exit (1);
	}
	host = argv[1];
	projet_1 (host);
exit (0);
}